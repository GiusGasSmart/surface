{% extends "base.html" %} {% block content %} {% load static %}
<div class="srf-container">
  <div id="app" v-cloak>
    <v-app>

      <v-alert v-model="request_error" dismissible type="error">
        [[ request_error_message ]]
      </v-alert>

      <v-overlay :value="loading">
        <v-progress-circular
          indeterminate
          size="64"
        ></v-progress-circular>
      </v-overlay>

      <v-dialog v-model="dialog_update" width="50%">
        <v-card>
          <v-card-title class="text-h5">
            Creating a new equipment
          </v-card-title>
          <v-layout column>
            <v-layout ma-2>
              <v-flex mr-2>
                <v-autocomplete
                  :items="equipment_types"
                  item-text="name"
                  item-value="id"
                  v-model="equipment.equipment_type_id"
                  label="Type of the equipment"
                  required
                  hint="*Required"
                  persistent-hint
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>                
              </v-flex>
              <v-flex>
                <v-autocomplete
                  :items="manufacturers"
                  item-text="name"
                  item-value="id"
                  v-model="equipment.manufacturer_id"
                  label="Manufacturer"
                  required
                  hint="*Required"
                  persistent-hint
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>    
              </v-flex>
            </v-layout>            
            <v-layout mx-2 mb-2>
              <v-flex mr-2>
                  <v-text-field
                    label="Model"
                    v-model="equipment.model"
                    required
                    hint="*Required"
                    persistent-hint                      
                    single-line
                    type="text"
                  ></v-text-field>                
                </v-flex>
              <v-flex>
                <v-text-field
                  label="Serial Number"
                  v-model="equipment.serial_number"
                  required
                  hint="*Required"
                  persistent-hint   
                  single-line
                  type="text"
                ></v-text-field>
              </v-flex>
            </v-layout>
            <v-layout mx-2 mb-2>
              <v-flex mr-2>            
                <v-menu
                  :close-on-content-click="false"
                  v-model="equipment.acquired_menu"
                  transition="scale-transition"
                  offset-y
                  class="max-50"
                >
                  <template v-slot:activator="{ on }">
                    <v-text-field
                    v-model="equipment.acquired"
                    label="Date of Acquirement"
                    v-on="on"
                    required
                    hint="*Required"
                    persistent-hint
                    prepend-icon="event"
                    ></v-text-field>
                  </template>
                  <v-date-picker
                    v-model="equipment.acquired"
                    @input="equipment.acquired_menu = false"
                  ></v-date-picker>
                </v-menu>
              </v-flex>
              <v-flex>            
                <v-menu
                  :close-on-content-click="false"
                  v-model="equipment.first_deployed_menu"
                  transition="scale-transition"
                  offset-y
                  class="max-50"
                >
                  <template v-slot:activator="{ on }">
                    <v-text-field
                    v-model="equipment.first_deployed"
                    label="Date of First Deployment"
                    v-on="on"
                    required
                    persistent-hint
                    prepend-icon="event"
                    ></v-text-field>
                  </template>
                  <v-date-picker
                    v-model="equipment.first_deployed"
                    @input="equipment.first_deployed_menu = false"
                  ></v-date-picker>
                </v-menu>
              </v-flex>              
            </v-layout>              
          </v-layout>                   
          <v-card-actions>
            <v-btn width="50%" color="primary" @click="dialog_update = false; updateEquipment()">
              Create Equipment
            </v-btn>
            <v-btn width="50%" @click="dialog_update = false">
              Cancel
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialog_new" width="50%">
        <v-card>
          <v-card-title class="text-h5">
            Creating a new equipment
          </v-card-title>
          <v-layout column>
            <v-layout ma-2>
              <v-flex mr-2>
                <v-autocomplete
                  :items="equipment_types"
                  item-text="name"
                  item-value="id"
                  v-model="equipment.equipment_type"
                  label="Type of the equipment"
                  required
                  hint="*Required"
                  persistent-hint
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>                
              </v-flex>
              <v-flex>
                <v-autocomplete
                  :items="manufacturers"
                  item-text="name"
                  item-value="id"
                  v-model="equipment.manufacturer"
                  label="Manufacturer"
                  required
                  hint="*Required"
                  persistent-hint
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>    
              </v-flex>
            </v-layout>            
            <v-layout mx-2 mb-2>
              <v-flex mr-2>
                  <v-text-field
                    label="Model"
                    v-model="equipment.model"
                    required
                    hint="*Required"
                    persistent-hint                      
                    single-line
                    type="text"
                  ></v-text-field>                
                </v-flex>
              <v-flex>
                <v-text-field
                  label="Serial Number"
                  v-model="equipment.serial_number"
                  required
                  hint="*Required"
                  persistent-hint   
                  single-line
                  type="text"
                ></v-text-field>
              </v-flex>
            </v-layout>
            <v-layout mx-2 mb-2>
              <v-flex mr-2>            
                <v-menu
                  :close-on-content-click="false"
                  v-model="equipment.acquired_menu"
                  transition="scale-transition"
                  offset-y
                  class="max-50"
                >
                  <template v-slot:activator="{ on }">
                    <v-text-field
                    v-model="equipment.acquired"
                    label="Date of Acquirement"
                    v-on="on"
                    required
                    hint="*Required"
                    persistent-hint
                    prepend-icon="event"
                    ></v-text-field>
                  </template>
                  <v-date-picker
                    v-model="equipment.acquired"
                    @input="equipment.acquired_menu = false"
                  ></v-date-picker>
                </v-menu>
              </v-flex>
              <v-flex>            
                <v-menu
                  :close-on-content-click="false"
                  v-model="equipment.first_deployed_menu"
                  transition="scale-transition"
                  offset-y
                  class="max-50"
                >
                  <template v-slot:activator="{ on }">
                    <v-text-field
                    v-model="equipment.first_deployed"
                    label="Date of First Deployment"
                    v-on="on"
                    required
                    persistent-hint
                    prepend-icon="event"
                    ></v-text-field>
                  </template>
                  <v-date-picker
                    v-model="equipment.first_deployed"
                    @input="equipment.first_deployed_menu = false"
                  ></v-date-picker>
                </v-menu>
              </v-flex>              
            </v-layout>              
          </v-layout>                   
          <v-card-actions>
            <v-btn width="50%" color="primary" @click="dialog_new = false; createEquipment()">
              Create Equipment
            </v-btn>
            <v-btn width="50%" @click="dialog_new = false">
              Cancel
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialog_del" width="50%">
        <v-card>
          <v-card-title class="text-h5">
            Do you want to delete this equipment?
          </v-card-title>
          <v-layout mx-6 mb-2 class="srf-display-2" column>
            <v-layout>
              Equipment Type: [[equipment.equipment_type]]
            </v-layout>
            <v-layout>
              Manufacturer: [[equipment.manufacturer]]
            </v-layout>                
            <v-layout>
              Model: [[equipment.model]]
            </v-layout>
            <v-layout>
              Serial Number: [[equipment.serial_number]]
            </v-layout>
          </v-layout>
          <v-card-actions>
            <v-btn
              width="50%"
              color="error"
              @click="dialog_del = false; deleteEquipment(equipment.equipment_id)"
            >
              Delete Equipment
            </v-btn>
            <v-btn width="50%" @click="dialog_del = false">
              Cancel
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <v-content fluid fill-height style="background: white">
        <v-layout column>
          <div class="srf-flex flex-row align-items-center justify-content-between srf-padding">
            <span class="srf-display-1 text-uppercase">Equipment Inventory</span
            ><br/>
          </div>
        </v-layout>

        <v-layout>
          <v-flex lg3 mr-5>
            <v-text-field
              v-model="search"
              label="General Search"
              append-icon="search">
            </v-text-field>
          </v-flex>
          <v-flex lg1 mt-5>
            {% if perms.wx.add_equipment %}
            <v-btn small label color="primary" @click="getEquipmentData(); dialog_new = true">
              New Equipment
            </v-btn>
            {% endif %}            
          </v-flex>
        </v-layout>

        <v-layout>
          <v-flex lg12 mr-5>
            <v-data-table
              :headers="headers"
              :items="equipments"
              class="elevation-1"
              :search="search"
            >
              <template v-slot:item.actions="{ item }">
                {% if perms.wx.change_equipment %}
                <v-tooltip bottom>
                  <template v-slot:activator="{ on }">
                    <v-btn icon> <v-icon v-on="on" small @click="dialog_update=true; equipment=item"> edit</v-icon></v-btn>
                  </template>
                  <span>Update Equipment</span>
                </v-tooltip>
                {% endif %}

                {% if perms.wx.delete_equipment %}
                  <v-tooltip bottom>
                    <template v-slot:activator="{ on }">
                      <v-btn icon> <v-icon color="error" v-on="on" small @click="dialog_del=true; equipment=item">delete</v-icon></v-btn>
                    </template>
                    <span>Delete Equipment</span>
                  </v-tooltip>
                {% endif %}
              </template>              
            </v-data-table>
          </v-flex>            
        </v-layout>
      </v-content>
    </v-app>
  </div>
</div>
{% endblock %} {% block localjavascript %}
  <script>
    Vue.use(window.vuelidate.default);
    const { required, minLength } = window.validators;
    new Vue({
      el: "#app",
      vuetify: new Vuetify(),
      delimiters: ["[[", "]]"],
      data:{
        search: '',
        loading: false,
        request_error_message: null,
        request_error: false,
        dialog_new: false,
        dialog_del: false,
        dialog_update: false,
        equipment_types: [],
        equipment: {
          equipment_id: null,
          equipment_type: null,
          equipment_type_id: null,
          manufacturer: null,
          manufacturer_id: null,
          model: null,
          serial_number: null,
          acquired: moment().format('YYYY-MM-DD'),
          acquired_menu: false,
          first_deployed: moment().format('YYYY-MM-DD'),
          first_deployed_menu: false,
        },
        headers: [
          { text: 'Equipment Type', align: 'left', value: 'equipment_type' },
          { text: 'Manufacturer', align: 'center',value: 'manufacturer' },
          { text: 'Model', align: 'center', value: 'model' },
          { text: 'Serial Number', align: 'center', value: 'serial_number' },
          { text: 'Acquired', align: 'center', value: 'acquired' },
          { text: 'First Deployed', align: 'center', value: 'first_deployed' },
          { text: 'Last Deployed', align: 'center', value: 'last_deployed' },
          { text: 'Location', align: 'center', value: 'location' },
          { text: 'Condition', align: 'center', value: 'condition' },
          { text: 'Actions', align: 'center', value: 'actions', sortable: false },
        ],
        equipments: [],
      },
      computed: {
        shouldClearEquipment() {
          return !(this.dialog_new || this.dialog_del || this.dialog_update);
        }
      },
      watch: {
        shouldClearEquipment(newVal){
          if (newVal){
            this.equipment = {
              equipment_id: null,
              equipment_type: null,
              equipment_type_id: null,
              manufacturer: null,
              manufacturer_id: null,
              model: null,
              serial_number: null,
              acquired: moment().format('YYYY-MM-DD'),
              acquired_menu: false,
              first_deployed: moment().format('YYYY-MM-DD'),
              first_deployed_menu: false,
            };            
          }
        }
      },
      methods: {
        getEquipmentData(){
          axios({
            method: 'get',
            url: `/wx/maintenance_reports/equipment_inventory/get/`,
          })          
          .then(
            res => {
              this.equipments = res.data['equipments'];
              this.equipment_types = res.data['equipment_types'];
              this.manufacturers = res.data['manufacturers'];
          });
        },
        createEquipment(){
          this.loading = true;
          axios({
            method: 'post',
            url: `/wx/maintenance_reports/equipment_inventory/create/`,
            params: {
              'equipment_type': this.equipment.equipment_type,
              'manufacturer': this.equipment.manufacturer,
              'model': this.equipment.model,              
              'serial_number': this.equipment.serial_number,
              'acquired': this.equipment.acquired,
              'first_deployed': this.equipment.first_deployed
            },
          }) 
          .then(
            res => {
              this.getEquipmentData();
          })  
          .catch((error) => {
            console.log("error", error.response);
            this.request_error_message = error.response.data.message;
            this.request_error = true;
          })
          .finally(() => {
            this.loading = false;
          });
        },
        deleteEquipment(equipment_id){
          this.loading = true;
          axios({
            method: 'post',
            url: `/wx/maintenance_reports/equipment_inventory/delete/`,
            params: {
              'equipment_id': equipment_id,
            },
          }) 
          .then(
            res => {
              this.getEquipmentData();
          })  
          .catch((error) => {
            console.log("error", error.response);
            this.request_error_message = error.response.data.message;
            this.request_error = true;
          })
          .finally(() => {
            this.loading = false;
          });
        },        
        updateEquipment(){
          this.loading = true;
          axios({
            method: 'post',
            url: `/wx/maintenance_reports/equipment_inventory/update/`,
            params: {
              'equipment_id': this.equipment.equipment_id,
              'equipment_type': this.equipment.equipment_type_id,
              'manufacturer': this.equipment.manufacturer_id,
              'model': this.equipment.model,              
              'serial_number': this.equipment.serial_number,
              'acquired': this.equipment.acquired,
              'first_deployed': this.equipment.first_deployed
            },
          }) 
          .then(
            res => {
              this.getEquipmentData();
          })  
          .catch((error) => {
            console.log("error", error.response);
            this.request_error_message = error.response.data.message;
            this.request_error = true;
          })
          .finally(() => {
            this.loading = false;
          });

        },        
      },
      created() {
        axios.defaults.xsrfHeaderName = "X-CSRFToken";
        axios.defaults.xsrfCookieName = "csrftoken";        
        this.getEquipmentData();
      },
    });
  </script>

{% endblock %}